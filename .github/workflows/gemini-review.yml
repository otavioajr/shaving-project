name: '沐 Gemini Review'

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # Permite rodar manualmente para testes

# Garante que apenas um review rode por vez no mesmo PR
concurrency:
  group: '${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}'
  cancel-in-progress: true

jobs:
  review:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 10
    permissions:
      contents: 'read'
      pull-requests: 'write' # Necessaﾌ〉io para postar o comentaﾌ〉io de review
      issues: 'write'

    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'

      - name: 'Run Gemini PR Review'
        uses: 'google-github-actions/run-gemini-cli@v0'
        id: 'gemini_pr_review'
        env:
          # Usamos o segredo padraﾌバ do GitHub para permissoﾌテs de escrita
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        with:
          # Autenticacﾌｧaﾌバ via Google AI Studio
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_model: 'gemini-1.5-pro'
          
          # Correcﾌｧaﾌバ da flag depreciada: agora usamos o comando direto
          command: 'review'
          
          # Configuracﾌｧoﾌテs simplificadas e estaﾌ」eis
          settings: |-
            {
              "model": {
                "maxSessionTurns": 15
              },
              "mcpServers": {
                "github": {
                  "command": "npx",
                  "args": [
                    "-y",
                    "@modelcontextprotocol/server-github"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              }
            }
