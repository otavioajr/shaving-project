name: 'ðŸ”€ Gemini Dispatch'

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened]
  issues:
    types: [opened, reopened]

jobs:
  dispatch:
    # SÃ³ dispara se for uma PR/Issue e se o comentÃ¡rio comeÃ§ar com @gemini-cli
    # Ou se for uma nova PR sendo aberta (para review automÃ¡tico)
    if: |-
      github.event_name == 'pull_request' || 
      github.event_name == 'issues' ||
      (github.event.sender.type == 'User' && startsWith(github.event.comment.body, '@gemini-cli'))

    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'write'

    outputs:
      command: '${{ steps.extract_command.outputs.command }}'
      additional_context: '${{ steps.extract_command.outputs.additional_context }}'

    steps:
      - name: 'Extract command'
        id: 'extract_command'
        uses: 'actions/github-script@v7'
        env:
          EVENT_TYPE: '${{ github.event_name }}.${{ github.event.action }}'
          REQUEST: "${{ github.event.comment.body || github.event.review.body || github.event.issue.body || ' }}"
        with:
          script: |
            const eventType = process.env.EVENT_TYPE;
            const request = process.env.REQUEST;

            if (eventType === 'pull_request.opened') {
              core.setOutput('command', 'review');
            } else if (eventType.startsWith('issues.opened')) {
              core.setOutput('command', 'triage');
            } else if (request.includes("/review")) {
              core.setOutput('command', 'review');
              core.setOutput('additional_context', request.replace(/@gemini-cli\s*\/review/, '').trim());
            } else if (request.includes("/triage")) {
              core.setOutput('command', 'triage');
            } else {
              core.setOutput('command', 'invoke');
              core.setOutput('additional_context', request.replace(/@gemini-cli/, '').trim());
            }

      - name: 'Acknowledge request'
        if: github.event_name == 'issue_comment'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ github.event.issue.number || github.event.pull_request.number }}'
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– Recebido! Estou processando seu pedido com Gemini 2.0... ðŸš€" \
            --repo "${{ github.repository }}"

  # Chama o arquivo de Review que vocÃª jÃ¡ corrigiu
  review:
    needs: 'dispatch'
    if: needs.dispatch.outputs.command == 'review'
    uses: './.github/workflows/gemini-review.yml'
    secrets: inherit

  # Chama o arquivo de Triage
  triage:
    needs: 'dispatch'
    if: needs.dispatch.outputs.command == 'triage'
    uses: './.github/workflows/gemini-triage.yml'
    secrets: inherit

  # Chama o arquivo de Invoke (Perguntas gerais)
  invoke:
    needs: 'dispatch'
    if: needs.dispatch.outputs.command == 'invoke'
    uses: './.github/workflows/gemini-invoke.yml'
    with:
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'
    secrets: inherit
