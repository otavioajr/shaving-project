generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  ADMIN
  BARBER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  PIX
}

enum TransactionType {
  INCOME
  EXPENSE
}

// ==========================================
// MODELS
// ==========================================

/// Tenant root entity - represents a barbershop
model Barbershop {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  professionals Professional[]
  clients       Client[]
  services      Service[]
  appointments  Appointment[]
  transactions  Transaction[]

  @@map("barbershops")
}

/// Professional users (barbers and admins)
model Professional {
  id             String   @id @default(cuid())
  barbershopId   String
  name           String
  email          String
  passwordHash   String
  commissionRate Decimal  @db.Decimal(5, 2) // e.g., 50.00 for 50%
  role           Role     @default(BARBER)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  barbershop          Barbershop    @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  appointments        Appointment[] @relation("ProfessionalAppointments")
  createdAppointments Appointment[] @relation("CreatedByProfessional")
  transactions        Transaction[]

  // Constraints
  @@unique([barbershopId, email])
  @@index([barbershopId])
  @@index([barbershopId, isActive])
  @@map("professionals")
}

/// Clients of the barbershop
model Client {
  id               String   @id @default(cuid())
  barbershopId     String
  name             String
  phone            String
  pushSubscription Json? // Web Push subscription object
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  barbershop   Barbershop    @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  // Constraints
  @@unique([barbershopId, phone])
  @@index([barbershopId])
  @@index([barbershopId, isActive])
  @@map("clients")
}

/// Services offered by the barbershop
model Service {
  id           String   @id @default(cuid())
  barbershopId String
  name         String
  price        Decimal  @db.Decimal(10, 2)
  duration     Int // Duration in minutes
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  barbershop   Barbershop    @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  // Constraints
  @@index([barbershopId])
  @@index([barbershopId, isActive])
  @@map("services")
}

/// Appointments/bookings
model Appointment {
  id              String            @id @default(cuid())
  barbershopId    String
  professionalId  String
  clientId        String
  serviceId       String
  createdById     String
  date            DateTime
  status          AppointmentStatus @default(PENDING)
  price           Decimal           @db.Decimal(10, 2) // Snapshot of service price at booking time
  commissionValue Decimal?          @db.Decimal(10, 2) // Calculated when status -> COMPLETED
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  barbershop   Barbershop   @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  professional Professional @relation("ProfessionalAppointments", fields: [professionalId], references: [id])
  client       Client       @relation(fields: [clientId], references: [id])
  service      Service      @relation(fields: [serviceId], references: [id])
  createdBy    Professional @relation("CreatedByProfessional", fields: [createdById], references: [id])

  // Constraints - optimized for common queries
  @@index([barbershopId, professionalId, date])
  @@index([barbershopId, status])
  @@index([barbershopId, date])
  @@index([barbershopId, clientId])
  @@map("appointments")
}

/// Financial transactions
model Transaction {
  id            String          @id @default(cuid())
  barbershopId  String
  createdById   String
  amount        Decimal         @db.Decimal(10, 2)
  type          TransactionType
  category      String
  description   String?
  date          DateTime
  paymentMethod PaymentMethod?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  barbershop Barbershop   @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  createdBy  Professional @relation(fields: [createdById], references: [id])

  // Constraints
  @@index([barbershopId, date])
  @@index([barbershopId, type])
  @@index([barbershopId, category])
  @@map("transactions")
}
